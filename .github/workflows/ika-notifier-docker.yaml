name: Build and Push Ika Notifier Docker Image

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'The network to build the image for (mainnet, testnet, devnet)'
        required: true
        type: string
        options:
          - mainnet
          - testnet
          - devnet
        default: devnet
      version:
        description: 'Version to tag the image (semver format e.g., 1.0.0, 1.2.3-beta, 1.2.3+build.1)'
        required: true
        default: 1.0.0
        type: string

env:
  GH_DEPLOY_KEY: ${{ secrets.GH_DEPLOY_KEY }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate semver version format
        run: |
          SEMVER_REGEX='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$'

          if [[ ! "${{ inputs.version }}" =~ $SEMVER_REGEX ]]; then
            echo "Error: Version must be valid SemVer (e.g., 1.0.0, 1.2.3-beta, 1.2.3+build.1)"
            exit 1
          fi
          echo "Version semver format is valid: ${{ inputs.version }}"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.GAR_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Setup SSH for manual git
        if: env.GH_DEPLOY_KEY
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.GH_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Globally rewrite any GitHub HTTPS to SSH
        if: env.GH_DEPLOY_KEY
        run: |
          git config --global url."git@github.com:dwallet-labs/cryptography-private".insteadOf "https://github.com/dwallet-labs/cryptography-private"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image (with Cargo cache)
        uses: docker/build-push-action@v6
        with:
          # Root context so Cargo.toml, crates/, etc are available
          context: .
          file: ./docker/ika-node/Dockerfile

          push: true
          tags: |
            us-docker.pkg.dev/common-449616/ika-common-public-containers/ika-notifier:${{ inputs.network }}-v${{ inputs.version }}

          # BuildKit cache backed by GitHub Actions
          cache-from: type=gha
          cache-to: type=gha,mode=max

          # Pass GH_DEPLOY_KEY securely as a BuildKit secret
          secrets: |
            GH_DEPLOY_KEY=${{ secrets.GH_DEPLOY_KEY }}

          # Normal build args (no secrets here)
          build-args: |
            NO_DEFAULT_FEATURES=true
            PROFILE=release
            GIT_REVISION=${{ github.sha }}
            BUILD_DATE=${{ github.run_started_at }}